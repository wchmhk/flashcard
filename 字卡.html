<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="概念表">
    <link rel="apple-touch-icon" href="圖標URL.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌏軒Sir的地理科程式 - 概念表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Quill.js is used for rendering rich text content, not for editing -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.min.js"></script>

    <style>
        /* Key Concepts View Styles */
        .sheet-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }

        .sheet-tab.active {
            background-color: #5D5CDE;
            color: white;
            border-color: #5D5CDE;
        }

        .dark .sheet-tab {
            border-color: #4b5563;
        }

        .dark .sheet-tab.active {
            background-color: #5D5CDE;
            border-color: #5D5CDE;
        }

        /* Spacing for paragraphs and lists in the concept display area */
        #keyConceptsContent p,
        .quill-content-preview-table p {
            margin-bottom: 1rem;
        }

        #keyConceptsContent ul, #keyConceptsContent ol,
        .quill-content-preview-table ul, .quill-content-preview-table ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        #keyConceptsContent > *:last-child,
        .quill-content-preview-table > *:last-child {
            margin-bottom: 0;
        }

        /* Sidebar and Navigation Button Styles */
        .sidebar-open {
            transform: translateX(0) !important;
        }

        #sidebar-nav a.active {
            background-color: #5D5CDE;
            color: white;
        }

        #sidebar-nav a:not(.active):hover {
            background-color: rgba(93, 92, 222, 0.1);
        }

        .dark #sidebar-nav a:not(.active):hover {
            background-color: rgba(93, 92, 222, 0.2);
        }

        /* Primary Button Style */
        .bg-primary {
          background-color: #5D5CDE;
          border: 1px solid #5D5CDE;
        }
        .bg-primary:hover {
            background-color: #4c4baf;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen" referrerpolicy="no-referrer">

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0 bg-white dark:bg-gray-800 shadow-xl">
        <div class="h-full px-3 py-4 overflow-y-auto">
            <h1 class="text-2xl font-semibold text-center text-primary mb-6">🌏軒Sir的地理科程式</h1>
            <ul id="sidebar-nav" class="space-y-2 font-medium">
                <li>
                    <a href="#" data-section="keyConcepts" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                        <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21"><path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"/><path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.026V10h8.975a1 1 0 0 0 1-.934 8.5 8.5 0 0 0-9.475-9.093Z"/></svg>
                        <span class="ms-3">關鍵概念一覽表</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="dataManagement" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                        <svg class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 18"><path d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286C0 7.169.831 8 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0Zm10 0h-4.286A1.857 1.857 0 0 0 10 1.857v4.286C10 7.169 10.831 8 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Zm-10 10H1.857A1.857 1.857 0 0 0 0 11.857v4.286C0 17.169.831 18 1.857 18h4.286A1.857 1.857 0 0 0 8 16.143v-4.286A1.857 1.857 0 0 0 6.143 10Zm10 0h-4.286A1.857 1.857 0 0 0 10 11.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 18 16.143v-4.286A1.857 1.857 0 0 0 16.143 10Z"/></svg>
                        <span class="ms-3">數據管理</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Mobile Top Bar -->
    <div class="sm:hidden sticky top-0 z-30 w-full bg-white dark:bg-gray-900 shadow-md p-2 flex items-center">
        <button id="hamburger-btn" type="button" class="inline-flex items-center p-2 text-sm text-gray-500 rounded-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
            <span class="sr-only">Open sidebar</span>
            <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
               <path clip-rule="evenodd" fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 5A.75.75 0 012.75 9h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 9.75zm0 5A.75.75 0 012.75 14h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 14.75z"></path>
            </svg>
        </button>
        <h1 class="text-lg font-semibold text-primary ml-4">🌏軒Sir的地理科程式</h1>
    </div>

    <!-- Main Content Area -->
    <main class="sm:ml-64">
        <div class="container mx-auto px-4 py-4 max-w-3xl flex flex-col">

            <!-- Key Concepts Section -->
            <div id="keyConceptsSection" class="space-y-6 hidden">
              <div id="keyConceptsSheetList" class="flex flex-wrap gap-2 mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">
              </div>

              <div id="keyConceptsControlsContainer" class="flex items-center gap-4 mb-4 hidden">
                  <div class="relative flex-grow">
                      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                          </svg>
                      </div>
                      <input type="text" id="keyConceptsSearchInput" placeholder="在此工作表中搜尋..." class="bg-white dark:bg-gray-800 w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-base">
                  </div>
                  <button id="toggleAllConceptsBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg text-sm whitespace-nowrap hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                      展開全部
                  </button>
              </div>

              <div id="keyConceptsContent" class="space-y-3">
                    <div class="text-center py-10 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <h3 class="text-lg font-medium">無可用數據</h3>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">請先使用「數據管理」頁面的「從 Google Sheets 導入」功能載入您的概念表。</p>
                        <button id="goToImportBtnFromConcepts" class="mt-4 bg-primary hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                            前往導入
                        </button>
                    </div>
                </div>
            </div>

            <!-- Data Management Section -->
            <div id="dataManagementSection" class="space-y-10 hidden">
                <h2 class="text-2xl font-bold">數據管理</h2>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border border-gray-300 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-600 pb-3">匯入數據</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">從外部檔案將概念表匯入到本程式中。匯入的數據將會生成對應的字卡與卡組，用於備份。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="importExcelBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd" />
                            </svg>
                            從 Excel 導入
                        </button>
                        <button id="importGSheetsBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5C3.9 3 3 3.9 3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
                                <path d="M7 7h2v10H7zm4 0h2v10h-2zm4 0h2v10h-2z"/>
                            </svg>
                            從 Google Sheets 導入
                        </button>
                        <label for="importDataInput" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                            </svg>
                            匯入備份 (.json)
                            <input id="importDataInput" type="file" accept=".json" class="hidden">
                        </label>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border border-gray-300 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-600 pb-3">匯出數據</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">將本程式中的資料匯出成檔案，用於備份或在其他裝置上使用。</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            導出為 Excel
                        </button>
                        <button id="exportDataBtn" class="bg-primary hover:bg-opacity-80 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            匯出備份 (.json)
                        </button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow border border-yellow-500/50 dark:border-yellow-400/50">
                    <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 dark:border-gray-600 pb-3 text-yellow-600 dark:text-yellow-300">本地儲存管理</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6 text-sm">
                        您的資料會自動儲存在此瀏覽器中。您也可以手動執行以下操作。
                        <br>
                        <span id="lastSavedTimestamp" class="text-xs mt-2 block">最後儲存時間：尚未儲存</span>
                    </p>
                    <div class="flex flex-wrap gap-4">
                        <button id="forceSaveBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                            立即儲存
                        </button>
                        <button id="clearLocalStorageBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            清除此瀏覽器的所有存檔
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Sidebar Overlay for mobile -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 z-30 bg-gray-900/50 sm:hidden"></div>

    <!-- All Modals for Data Management -->

    <!-- Enhanced Export Modal (with deck selection) -->
    <div id="exportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">匯出數據</h2>
            <div class="space-y-4">
                <div>
                    <label for="exportFilenameInput" class="block text-sm font-medium mb-1">檔案名稱</label>
                    <input type="text" id="exportFilenameInput" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 text-base" value="flashcards_data" />
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">選擇要匯出的卡組</label>
                        <div class="flex space-x-2">
                            <button id="selectAllExportDecksBtn" class="text-xs text-primary hover:underline">全選</button>
                            <button id="deselectAllExportDecksBtn" class="text-xs text-primary hover:underline">取消全選</button>
                        </div>
                    </div>
                    <div id="exportDecksList" class="max-h-60 overflow-y-auto space-y-2 border border-gray-300 dark:border-gray-700 rounded-lg p-2">
                        <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                            沒有可用的卡組。
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelExportBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg">
                        取消
                    </button>
                    <button id="confirmExportBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg">
                        匯出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Preview Modal -->
    <div id="importPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-xl w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">匯入預覽</h2>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">選擇要匯入的卡組</label>
                        <div class="flex space-x-2">
                            <button id="selectAllImportDecksBtn" class="text-xs text-primary hover:underline">全選</button>
                            <button id="deselectAllImportDecksBtn" class="text-xs text-primary hover:underline">取消全選</button>
                        </div>
                    </div>
                    <div id="importDecksList" class="max-h-60 overflow-y-auto space-y-2 border border-gray-300 dark:border-gray-700 rounded-lg p-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">衝突處理方式</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="conflictResolution" value="overwrite" checked class="mr-2">
                            <span>覆蓋 - 用匯入的卡組替換現有同名卡組</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="conflictResolution" value="rename" class="mr-2">
                            <span>重命名 - 為匯入的卡組添加數字後綴</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="conflictResolution" value="merge" class="mr-2">
                            <span>合併 - 將匯入的字卡合併到現有卡組</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="conflictResolution" value="skip" class="mr-2">
                            <span>跳過 - 不匯入衝突的卡組</span>
                        </label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelImportBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg">
                        取消
                    </button>
                    <button id="confirmImportBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg">
                        匯入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel導入對話框 -->
    <div id="importExcelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-3xl w-full mx-4 my-auto">
            <h2 class="text-xl font-semibold mb-4">從Excel導入概念</h2>
            <div id="excelImportSteps" class="overflow-y-auto">
                <div id="excelStep1" class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-700 p-6 rounded-lg text-center">
                        <p class="mb-4 text-gray-600 dark:text-gray-400">選擇Excel檔案（.xls或.xlsx）</p>
                        <p class="mb-4 text-sm text-gray-500 dark:text-gray-500">Excel第一列應為表頭，第二列開始為字卡數據。<br>至少需要兩列：第一列為正面內容，第二列為背面內容。<br>多個工作表將被識別為不同卡組。</p>
                        <div>
                            <label for="excelFileInput" class="bg-primary hover:bg-opacity-80 text-white px-4 py-2 rounded-lg cursor-pointer">
                                選擇檔案
                                <input type="file" id="excelFileInput" accept=".xls,.xlsx" class="hidden" />
                            </label>
                        </div>
                        <div id="excelFileName" class="mt-4 text-sm text-gray-500 dark:text-gray-500 hidden"></div>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button id="downloadExcelTemplateBtn" class="text-primary hover:underline text-sm">
                            下載Excel範本
                        </button>
                        <div>
                            <button id="closeImportExcelBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg mr-2">
                                取消
                            </button>
                            <button id="nextToPreviewBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg" disabled>
                                下一步
                            </button>
                        </div>
                    </div>
                </div>
                <div id="excelStep2" class="space-y-4 hidden">
                    <div class="mb-4 border border-gray-300 dark:border-gray-700 rounded-lg p-2">
                        <h3 class="font-medium mb-2">工作表</h3>
                        <div id="sheetTabsContainer" class="mb-2 flex flex-wrap"></div>
                    </div>
                    <div class="border border-gray-300 dark:border-gray-700 rounded-lg p-2">
                        <h3 class="font-medium mb-2">預覽數據</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-300 dark:divide-gray-700">
                                <thead id="excelPreviewHead" class="bg-gray-100 dark:bg-gray-800"></thead>
                                <tbody id="excelPreviewBody" class="divide-y divide-gray-200 dark:divide-gray-800"></tbody>
                            </table>
                        </div>
                        <p id="excelRowCount" class="text-sm text-gray-500 dark:text-gray-500 mt-2"></p>
                    </div>
                    <div class="border border-gray-300 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-2">設置欄位映射</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">概念/問題 (Title)</label>
                                <select id="frontColumnSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">定義/答案 (Content)</label>
                                <select id="backColumnSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800"></select>
                            </div>
                        </div>
                    </div>
                    <div class="border border-gray-300 dark:border-gray-700 rounded-lg p-4">
                        <h3 class="font-medium mb-2">設置工作表映射</h3>
                        <div id="sheetMappingContainer" class="space-y-4"></div>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button id="backToFileBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg">
                            上一步
                        </button>
                        <button id="importExcelDataBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg">
                            匯入數據
                        </button>
                    </div>
                </div>
                <div id="excelStep3" class="space-y-4 hidden">
                    <div id="importResults" class="border border-gray-300 dark:border-gray-700 rounded-lg p-4"></div>
                    <div class="mt-4 flex justify-between">
                        <button id="importNewFileBtn" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">
                            導入新檔案
                        </button>
                        <button id="finishImportBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white font-semibold rounded-lg transition-colors">
                            完成
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 導出Excel對話框 -->
    <div id="exportExcelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">導出Excel</h2>
            <div class="space-y-4">
                <div>
                    <label for="exportExcelFilenameInput" class="block text-sm font-medium mb-1">檔案名稱</label>
                    <input type="text" id="exportExcelFilenameInput" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 text-base" value="flashcards" />
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium">選擇要導出的卡組</label>
                        <div class="flex space-x-2">
                            <button id="selectAllExportExcelDecksBtn" class="text-xs text-primary hover:underline">全選</button>
                            <button id="deselectAllExportExcelDecksBtn" class="text-xs text-primary hover:underline">取消全選</button>
                        </div>
                    </div>
                    <div id="exportExcelDecksList" class="max-h-60 overflow-y-auto space-y-2 border border-gray-300 dark:border-gray-700 rounded-lg p-2">
                        <div class="text-center py-4 text-gray-500 dark:text-gray-400">
                            沒有可用的卡組。
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="cancelExportExcelBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg">
                        取消
                    </button>
                    <button id="confirmExportExcelBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg">
                        導出
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Sheets 導入對話框 -->
    <div id="importGSheetsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 overflow-y-auto py-10">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-3xl w-full mx-4 my-auto">
            <h2 class="text-xl font-semibold mb-4">從 Google Sheets 導入概念</h2>
            <div class="flex justify-between items-center mb-2 text-sm bg-gray-100 dark:bg-gray-700 p-2 rounded">
                <div>
                    <span class="font-medium">API Key 狀態:</span>
                    <span id="apiKeyStatus" class="ml-2">
                        <span class="text-green-600 dark:text-green-400" id="apiKeyPresent">已設定</span>
                        <span class="text-yellow-600 dark:text-yellow-400 hidden" id="apiKeyMissing">未設定 (無法同步粗體、底線、對齊、隔行等設置)</span>
                    </span>
                </div>
                <div class="flex space-x-2">
                    <button id="apiSettingsBtn" type="button" class="text-blue-500 hover:text-blue-700 text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">
                        設置 API Key
                    </button>
                    <button id="clearApiKeyBtn" type="button" class="text-red-500 hover:text-red-700 text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">
                        清除 API Key
                    </button>
                </div>
            </div>
            <div id="gSheetsImportSteps" class="overflow-y-auto">
                <div id="gSheetsStep1" class="space-y-4">
                    <p class="mb-4 text-gray-600 dark:text-gray-400">請輸入已共享的 Google Sheets URL</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500 mb-4">
                        注意：Google Sheets 必須設置為「任何人都可以查看」，並請確保第一列為標題行
                    </p>
                    <div class="space-y-2">
                        <label for="gSheetsUrlInput" class="block text-sm font-medium">Google Sheets URL</label>
                        <input type="text" id="gSheetsUrlInput" placeholder="例如：https://docs.google.com/spreadsheets/d/..."
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800">
                    </div>
                    <div class="flex items-center mt-2 bg-yellow-50 dark:bg-yellow-900/50 p-2 rounded-md border border-yellow-200 dark:border-yellow-700/50">
                        <input type="checkbox" id="setDefaultGSheetUrl" class="mr-2 h-4 w-4 text-primary focus:ring-primary">
                        <label for="setDefaultGSheetUrl" class="text-sm text-yellow-800 dark:text-yellow-200">
                            設為預設連結（每次開啟程式時自動載入此內容）
                        </label>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <div>
                            <a href="https://support.google.com/docs/answer/183965" target="_blank" class="text-primary hover:underline text-sm">
                                如何共享 Google Sheets?
                            </a>
                        </div>
                        <div>
                            <button id="closeGSheetsModalBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg mr-2">
                                取消
                            </button>
                            <button id="loadGSheetsBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg">
                                載入
                            </button>
                        </div>
                    </div>
                </div>
                <div id="gSheetsStep2" class="space-y-4 hidden">
                    <div id="formatStatusIndicator" class="mb-4 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm">
                        <span id="formatStatus" class="font-medium">格式狀態：</span>
                        <span id="formatStatusValue">載入中...</span>
                    </div>
                </div>
                <div id="gSheetsStep3" class="space-y-4 hidden"></div>
            </div>
        </div>
    </div>

    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-lg w-full mx-4">
            <h2 class="text-xl font-semibold mb-4">API設置</h2>
            <div class="space-y-4">
                <div>
                    <label for="googleApiKeyInput" class="block text-sm font-medium mb-1">Google API密鑰</label>
                    <input type="password" id="googleApiKeyInput" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 text-base" />
                    <div class="flex items-center mt-1">
                        <input type="checkbox" id="showApiKey" class="mr-2">
                        <label for="showApiKey" class="text-sm">顯示密鑰</label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">API密鑰用於訪問Google Sheets API，提供格式化數據。密鑰會安全地存儲在您的瀏覽器中。</p>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm">
                    <h3 class="font-medium text-blue-700 dark:text-blue-400">如何獲取Google API密鑰</h3>
                    <ol class="list-decimal list-inside mt-2 space-y-1 text-blue-600 dark:text-blue-300">
                        <li>訪問 <a href="https://console.cloud.google.com/" target="_blank" class="underline">Google Cloud Console</a></li>
                        <li>創建一個新項目</li>
                        <li>啟用 Google Sheets API</li>
                        <li>創建API密鑰 (憑證 → 創建憑證 → API密鑰)</li>
                        <li>複製API密鑰並粘貼到上面的輸入框</li>
                    </ol>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button id="closeApiSettingsBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg">
                        取消
                    </button>
                    <button id="saveApiSettingsBtn" class="px-4 py-2 bg-primary hover:bg-opacity-80 text-white rounded-lg">
                        保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-medium mb-4" id="confirmModalTitle">確認操作</h3>
            <p id="confirmModalMessage" class="mb-6">您確定要執行此操作嗎？</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmModalCancelBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 rounded-lg">
                    取消
                </button>
                <button id="confirmModalConfirmBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">
                    確認
                </button>
            </div>
        </div>
    </div>

</body>

<script>
    // Dark mode detection
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (event.matches) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    });

    // --- GLOBAL VARIABLES ---
    let GOOGLE_API_KEY = localStorage.getItem('google_api_key') || '';
    let cardsData = []; // Underlying data model for cards
    let decksData = []; // Underlying data model for decks (groups of cards)
    let excelSheets = {}; // Holds imported sheet data for the Key Concepts view
    let activeSheetName = '';
    let sheetMappings = {};
    let sheetOptions = {};
    let importDataCache = null;
    let selectedExportDeckIds = [];
    let selectedExportExcelDeckIds = [];
    let selectedImportDeckIds = [];

    // --- DOM ELEMENTS ---
    const keyConceptsSection = document.getElementById('keyConceptsSection');
    const dataManagementSection = document.getElementById('dataManagementSection');

    // --- UTILITY FUNCTIONS ---

    function showNotification(message, duration = 2000) {
        const notification = document.createElement('div');
        notification.className = 'fixed bottom-4 right-4 bg-primary text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-500 z-[100]';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 500);
        }, duration);
    }

    function stripHtml(html) {
        if (!html) return "";
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        return tempDiv.textContent || tempDiv.innerText || "";
    }

    function isBase64Image(str) {
        if (typeof str !== 'string') return false;
        if (str.startsWith('data:image/')) return true;
        try {
            const base64Regex = /^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/;
            return str.length > 100 && base64Regex.test(str);
        } catch (e) {
            return false;
        }
    }

    function ensureBase64Prefix(base64Str) {
        if (base64Str.startsWith('data:image/')) return base64Str;
        return `data:image/jpeg;base64,${base64Str}`;
    }

    function convertGoogleDriveLink(url) {
        if (!url || typeof url !== 'string') return null;
        let match = url.match(/drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/);
        if (match && match[1]) {
            const fileId = match[1];
            const directAccessUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
            return `https://images.weserv.nl/?url=${encodeURIComponent(directAccessUrl)}`;
        }
        return null;
    }

    function processImportedContent(content) {
        if (!content) return { text: '', image: null };
        const contentStr = String(content);

        const driveImageUrl = convertGoogleDriveLink(contentStr);
        if (driveImageUrl) {
            return { text: '', image: driveImageUrl };
        }
        if (isBase64Image(contentStr)) {
            return { text: '', image: ensureBase64Prefix(contentStr) };
        }
        return { text: contentStr, image: null };
    }

    function convertDeltaToHTML(delta) {
        if (!delta || !delta.ops) return '';
        const tempContainer = document.createElement('div');
        const q = new Quill(tempContainer);
        q.setContents(delta);
        return tempContainer.querySelector('.ql-editor').innerHTML;
    }

    function customConfirm(message, title, callback) {
        const confirmModal = document.getElementById('customConfirmModal');
        const confirmModalTitle = document.getElementById('confirmModalTitle');
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
        const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');

        confirmModalTitle.textContent = title || '確認操作';
        confirmModalMessage.textContent = message;
        confirmModal.classList.remove('hidden');

        const confirmHandler = () => {
            closeAndCleanup();
            callback(true);
        };
        const cancelHandler = () => {
            closeAndCleanup();
            callback(false);
        };
        const outsideClickHandler = (event) => {
            if (event.target === confirmModal) {
                cancelHandler();
            }
        };

        function closeAndCleanup() {
            confirmModal.classList.add('hidden');
            confirmModalConfirmBtn.removeEventListener('click', confirmHandler);
            confirmModalCancelBtn.removeEventListener('click', cancelHandler);
            document.removeEventListener('click', outsideClickHandler);
        }

        confirmModalConfirmBtn.addEventListener('click', confirmHandler);
        confirmModalCancelBtn.addEventListener('click', cancelHandler);
        document.addEventListener('click', outsideClickHandler);
    }

    // --- DATA MANAGEMENT (LOCAL STORAGE) ---

    function saveDataToLocalStorage() {
        try {
            const now = new Date();
            localStorage.setItem('flashcard_cardsData', JSON.stringify(cardsData));
            localStorage.setItem('flashcard_decksData', JSON.stringify(decksData));
            localStorage.setItem('flashcard_excelSheets', JSON.stringify(excelSheets));
            localStorage.setItem('flashcard_lastSaved', now.toISOString());
            console.log("數據已成功保存到 localStorage。");
            updateLastSavedTimestamp(now);
        } catch (e) {
            console.error("保存數據到 localStorage 失敗:", e);
            showNotification("錯誤：無法自動保存您的數據！請嘗試手動匯出。", 5000);
        }
    }

    function loadDataFromLocalStorage() {
        try {
            const savedCards = localStorage.getItem('flashcard_cardsData');
            const savedDecks = localStorage.getItem('flashcard_decksData');
            const savedExcelSheets = localStorage.getItem('flashcard_excelSheets');
            const lastSaved = localStorage.getItem('flashcard_lastSaved');

            if (savedCards) cardsData = JSON.parse(savedCards);
            if (savedDecks) decksData = JSON.parse(savedDecks);
            if (savedExcelSheets) excelSheets = JSON.parse(savedExcelSheets);
            if (lastSaved) updateLastSavedTimestamp(lastSaved);
        } catch (e) {
            console.error("從 localStorage 讀取數據失敗:", e);
            cardsData = [];
            decksData = [];
            excelSheets = {};
            showNotification("錯誤：讀取本地存檔失敗。", 5000);
        }
    }

    function updateLastSavedTimestamp(date) {
        const timestampEl = document.getElementById('lastSavedTimestamp');
        if (timestampEl) {
            if (date) {
                const dateObj = (typeof date === 'string') ? new Date(date) : date;
                timestampEl.textContent = `最後儲存時間：${dateObj.toLocaleString()}`;
            } else {
                timestampEl.textContent = '最後儲存時間：尚未儲存';
            }
        }
    }

    function clearLocalStorageData() {
        customConfirm(
            '您確定要清除儲存在這個瀏覽器上的所有字卡和卡組嗎？這個操作無法復原，除非您有另外匯出備份檔案。',
            '確認清除所有本地存檔',
            (confirmed) => {
                if (confirmed) {
                    localStorage.removeItem('flashcard_cardsData');
                    localStorage.removeItem('flashcard_decksData');
                    localStorage.removeItem('flashcard_excelSheets');
                    localStorage.removeItem('flashcard_lastSaved');
                    localStorage.removeItem('flashcard_defaultGSheetUrl');

                    cardsData = [];
                    decksData = [];
                    excelSheets = {};

                    showNotification('已清除所有本地存檔。頁面即將重新整理。', 3000);
                    setTimeout(() => window.location.reload(), 3000);
                }
            }
        );
    }

    // --- NAVIGATION AND UI ---

    function setupSidebarAndNavigation() {
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const navLinks = document.querySelectorAll('#sidebar-nav a');

        const toggleSidebar = () => {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        };

        if (hamburgerBtn && sidebar && overlay) {
            hamburgerBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
        }

        window.showSection = function(section) {
            navLinks.forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`#sidebar-nav a[data-section="${section}"]`);
            if (activeLink) activeLink.classList.add('active');

            keyConceptsSection.classList.add('hidden');
            dataManagementSection.classList.add('hidden');

            if (section === 'keyConcepts') {
                keyConceptsSection.classList.remove('hidden');
                loadKeyConceptsView();
            } else if (section === 'dataManagement') {
                dataManagementSection.classList.remove('hidden');
            }

            if (window.innerWidth < 640 && !sidebar.classList.contains('-translate-x-full')) {
                toggleSidebar();
            }
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                window.showSection(e.currentTarget.dataset.section);
            });
        });
    }

    function refreshAllViews() {
        console.log("Refreshing all UI components with new data...");
        if (!keyConceptsSection.classList.contains('hidden')) {
            loadKeyConceptsView();
        }
        showNotification('數據已成功導入並更新頁面！', 2500);
    }

    // --- KEY CONCEPTS VIEW ---

    function loadKeyConceptsView() {
        const sheetListContainer = document.getElementById('keyConceptsSheetList');
        const contentContainer = document.getElementById('keyConceptsContent');
        const controlsContainer = document.getElementById('keyConceptsControlsContainer');
        const searchInput = document.getElementById('keyConceptsSearchInput');
        const toggleAllBtn = document.getElementById('toggleAllConceptsBtn');

        sheetListContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        if (Object.keys(excelSheets).length === 0) {
            contentContainer.innerHTML = `
                <div class="text-center py-10 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h3 class="text-lg font-medium">無可用數據</h3>
                    <p class="mt-2 text-gray-600 dark:text-gray-400">請先使用「數據管理」頁面的「從 Google Sheets 導入」功能載入您的概念表。</p>
                    <button id="goToImportBtnFromConcepts" class="mt-4 bg-primary hover:bg-opacity-80 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                        前往導入
                    </button>
                </div>
            `;
            document.getElementById('goToImportBtnFromConcepts').addEventListener('click', () => {
                window.showSection('dataManagement');
                setTimeout(openGSheetsImportModal, 100);
            });
            controlsContainer.classList.add('hidden');
            return;
        }

        controlsContainer.classList.remove('hidden');
        searchInput.value = '';

        Object.keys(excelSheets).forEach(sheetName => {
            const button = document.createElement('button');
            button.textContent = sheetName;
            button.dataset.sheetName = sheetName;
            button.className = 'sheet-tab';
            button.addEventListener('click', () => {
                document.querySelectorAll('#keyConceptsSheetList button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                displaySheetConcepts(sheetName, searchInput.value);
            });
            sheetListContainer.appendChild(button);
        });

        searchInput.addEventListener('input', () => {
            const activeSheetBtn = document.querySelector('#keyConceptsSheetList button.active');
            if (activeSheetBtn) {
                displaySheetConcepts(activeSheetBtn.dataset.sheetName, searchInput.value);
            }
        });

        if (!toggleAllBtn.listenerAttached) {
            toggleAllBtn.addEventListener('click', () => {
                const isOpening = toggleAllBtn.textContent === '展開全部';
                document.querySelectorAll('#keyConceptsContent details').forEach(detail => detail.open = isOpening);
                toggleAllBtn.textContent = isOpening ? '收合全部' : '展開全部';
            });
            toggleAllBtn.listenerAttached = true;
        }

        if (sheetListContainer.firstChild) {
            sheetListContainer.firstChild.click();
        }
    }

    function displaySheetConcepts(sheetName, searchText = '') {
        const contentContainer = document.getElementById('keyConceptsContent');
        contentContainer.innerHTML = '';

        const sheet = excelSheets[sheetName];
        if (!sheet || !sheet.data || sheet.data.length < 2) {
            contentContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">此工作表無內容。</p>';
            return;
        }

        let conceptRows = sheet.data.slice(1);
        const lowerSearchText = searchText.trim().toLowerCase();

        if (lowerSearchText) {
            conceptRows = conceptRows.filter(row => {
                return (getCellTextContent(row[0]).toLowerCase().includes(lowerSearchText) ||
                        getCellTextContent(row[1]).toLowerCase().includes(lowerSearchText) ||
                       (row.length > 2 ? getCellTextContent(row[2]).toLowerCase().includes(lowerSearchText) : false));
            });
        }

        let itemsDisplayed = 0;
        conceptRows.forEach(row => {
            if (!getCellTextContent(row[0]).trim() && !getCellTextContent(row[1]).trim()) return;
            itemsDisplayed++;

            const detailsEl = document.createElement('details');
            detailsEl.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm group';

            const summaryEl = document.createElement('summary');
            summaryEl.className = 'font-medium text-lg list-none cursor-pointer flex justify-between items-center';
            summaryEl.innerHTML = `
                <div>${renderMixedContent(row[0]) || '<span class="italic text-gray-500">無標題</span>'}</div>
                <svg class="w-5 h-5 transition-transform duration-300 group-open:rotate-180 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            `;

            const answerDiv = document.createElement('div');
            answerDiv.className = 'mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 space-y-4';

            const definitionContent = renderMixedContent(row[1]);
            const extraInfoContent = row.length > 2 ? renderMixedContent(row[2]) : null;
            let finalAnswerHTML = '';
            if (definitionContent) finalAnswerHTML += `<div>${definitionContent}</div>`;
            if (extraInfoContent) finalAnswerHTML += `<div class="mt-2 p-3 bg-gray-100 dark:bg-gray-700 rounded text-sm">${extraInfoContent}</div>`;
            if (!finalAnswerHTML) finalAnswerHTML = '<p class="text-gray-500 italic">無詳細內容。</p>';

            answerDiv.innerHTML = finalAnswerHTML;
            detailsEl.append(summaryEl, answerDiv);
            contentContainer.appendChild(detailsEl);
        });

        const toggleBtn = document.getElementById('toggleAllConceptsBtn');
        toggleBtn.textContent = '展開全部';
        if (itemsDisplayed === 0) {
            contentContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-4">在此工作表中找不到符合「${searchText}」的內容。</p>`;
            toggleBtn.style.display = 'none';
        } else {
            toggleBtn.style.display = '';
        }
    }

    function renderMixedContent(cell) {
        if (!cell) return '';
        let contentStr = (typeof cell === 'object' && cell.delta) ? convertDeltaToHTML(cell.delta) : String(cell);
        const urlRegex = /(https?:\/\/drive\.google\.com\/(?:file\/d\/|open\?id=)[a-zA-Z0-9_-]+[^\s<]*)/g;
        let finalHTML = contentStr.replace(urlRegex, match => {
            const convertedUrl = convertGoogleDriveLink(match);
            return convertedUrl ? `<img src="${convertedUrl}" class="max-w-full h-auto rounded-lg my-2 block">` : match;
        });
        return finalHTML.replace(/\n/g, '<br>').trim();
    }

    function getCellTextContent(cell) {
        if (!cell) return '';
        if (typeof cell === 'object' && cell.delta) {
            const tempDiv = document.createElement('div');
            const tempQuill = new Quill(tempDiv);
            tempQuill.setContents(cell.delta);
            return tempQuill.getText();
        }
        return String(cell);
    }

    function convertGSheetsCellToQuillDelta(value, textFormatRuns, effectiveFormat) {
        if (!value) return { ops: [] };
        const ops = [];
        let lastIndex = 0;

        if (!textFormatRuns || textFormatRuns.length === 0) {
            const format = {};
            if (effectiveFormat?.textFormat?.bold) format.bold = true;
            if (effectiveFormat?.textFormat?.italic) format.italic = true;
            if (effectiveFormat?.textFormat?.underline) format.underline = true;
            ops.push({ insert: value, attributes: format });
        } else {
            textFormatRuns.forEach(run => {
                const startIndex = run.startIndex || 0;
                if (startIndex > lastIndex) {
                    ops.push({ insert: value.substring(lastIndex, startIndex) });
                }
                const text = value.substring(startIndex, (textFormatRuns.find(r => r.startIndex > startIndex)?.startIndex || value.length));
                const format = {};
                if (run.format?.bold) format.bold = true;
                if (run.format?.italic) format.italic = true;
                if (run.format?.underline) format.underline = true;
                ops.push({ insert: text, attributes: format });
                lastIndex = startIndex + text.length;
            });
            if (lastIndex < value.length) {
                ops.push({ insert: value.substring(lastIndex) });
            }
        }
        return { ops: ops };
    }

    // --- GOOGLE SHEETS IMPORT ---

    function initGSheetsImport() {
        const importGSheetsBtn = document.getElementById('importGSheetsBtn');
        const importGSheetsModal = document.getElementById('importGSheetsModal');
        const closeGSheetsModalBtn = document.getElementById('closeGSheetsModalBtn');
        const loadGSheetsBtn = document.getElementById('loadGSheetsBtn');

        importGSheetsBtn.addEventListener('click', openGSheetsImportModal);
        closeGSheetsModalBtn.addEventListener('click', closeGSheetsImportModal);
        loadGSheetsBtn.addEventListener('click', loadGSheetsData);

        document.getElementById('clearApiKeyBtn').addEventListener('click', () => {
            localStorage.removeItem('google_api_key');
            GOOGLE_API_KEY = '';
            updateApiKeyStatus();
            showNotification('Google API Key 已清除');
        });

        updateApiKeyStatus();
    }

    function updateApiKeyStatus() {
        const apiKeyPresent = document.getElementById('apiKeyPresent');
        const apiKeyMissing = document.getElementById('apiKeyMissing');
        if (GOOGLE_API_KEY) {
            apiKeyPresent.classList.remove('hidden');
            apiKeyMissing.classList.add('hidden');
        } else {
            apiKeyPresent.classList.add('hidden');
            apiKeyMissing.classList.remove('hidden');
        }
    }

    function openGSheetsImportModal() {
        const importGSheetsModal = document.getElementById('importGSheetsModal');
        const gSheetsUrlInput = document.getElementById('gSheetsUrlInput');
        const setDefaultCheckbox = document.getElementById('setDefaultGSheetUrl');
        const defaultUrl = localStorage.getItem('flashcard_defaultGSheetUrl');

        gSheetsUrlInput.value = defaultUrl || '';
        setDefaultCheckbox.checked = !!defaultUrl;

        importGSheetsModal.classList.remove('hidden');
        showGSheetsStep(1);
    }

    function closeGSheetsImportModal() {
        document.getElementById('importGSheetsModal').classList.add('hidden');
    }

    function showGSheetsStep(step) {
        document.getElementById('gSheetsStep1').classList.toggle('hidden', step !== 1);
        document.getElementById('gSheetsStep2').classList.toggle('hidden', step !== 2);
        document.getElementById('gSheetsStep3').classList.toggle('hidden', step !== 3);
    }

    function extractSpreadsheetId(url) {
        const match = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        return match ? match[1] : null;
    }

    function loadGSheetsData() {
        if (!GOOGLE_API_KEY) {
            showNotification('請先設置Google API密鑰');
            document.getElementById('apiSettingsModal').classList.remove('hidden');
            return;
        }

        const gSheetsUrl = document.getElementById('gSheetsUrlInput').value.trim();
        const setDefault = document.getElementById('setDefaultGSheetUrl').checked;
        const spreadsheetId = extractSpreadsheetId(gSheetsUrl);

        if (!spreadsheetId) {
            showNotification('請輸入有效的 Google Sheets URL');
            return;
        }

        if (setDefault) {
            localStorage.setItem('flashcard_defaultGSheetUrl', gSheetsUrl);
        } else {
            localStorage.removeItem('flashcard_defaultGSheetUrl');
        }

        const loadBtn = document.getElementById('loadGSheetsBtn');
        loadBtn.disabled = true;
        loadBtn.innerHTML = '<span class="inline-block animate-spin mr-2">⟳</span> 載入中...';

        loadFormattedGSheetsData(spreadsheetId)
            .then(() => {
                processSheetsIntoCardsAndDecks();
                refreshAllViews();
                saveDataToLocalStorage();
                closeGSheetsImportModal();
            })
            .catch(error => {
                showNotification(`載入失敗: ${error.message}`, 4000);
            })
            .finally(() => {
                loadBtn.disabled = false;
                loadBtn.textContent = '載入';
            });
    }

    function loadFormattedGSheetsData(spreadsheetId) {
        return new Promise((resolve, reject) => {
            if (typeof gapi === 'undefined' || typeof gapi.client === 'undefined') {
                return reject(new Error('Google API 未載入或初始化失敗'));
            }
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                }).then(() => gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: spreadsheetId,
                    includeGridData: true,
                    ranges: []
                })).then(response => {
                    excelSheets = {}; // Reset before populating
                    const sheets = response.result.sheets;
                    if (!sheets || sheets.length === 0) return reject(new Error('未找到工作表數據'));

                    sheets.forEach(sheet => {
                        const sheetName = sheet.properties.title;
                        const gridData = sheet.data[0];
                        if (!gridData || !gridData.rowData) return;

                        const formattedData = gridData.rowData.map(row => {
                            if (!row.values) return [];
                            return row.values.map(cell => ({
                                value: cell.formattedValue || '',
                                delta: convertGSheetsCellToQuillDelta(cell.formattedValue, cell.textFormatRuns, cell.effectiveFormat)
                            }));
                        });

                        excelSheets[sheetName] = {
                            data: formattedData,
                            columns: formattedData.length > 0 ? formattedData[0].map(cell => cell.value) : [],
                            hasFormatting: true,
                            isGSheet: true
                        };
                        sheetMappings[sheetName] = { deckOption: 'new', deckId: '', newDeckName: sheetName, newDeckDescription: '' };
                        sheetOptions[sheetName] = { frontColumn: 0, backColumn: 1 };
                    });
                    activeSheetName = Object.keys(excelSheets)[0];
                    resolve();
                }).catch(error => {
                    console.error('Google Sheets API 錯誤:', error);
                    reject(new Error(error.result?.error?.message || 'API 請求失敗'));
                });
            });
        });
    }

    function processSheetsIntoCardsAndDecks() {
        console.log("正在將工作表數據轉換為內部卡組和字卡...");
        Object.keys(excelSheets).forEach(sheetName => {
            if (!excelSheets[sheetName] || decksData.find(d => d.name === sheetName)) return;

            const newDeck = { id: Date.now() + Math.random(), name: sheetName, description: `從導入自動創建`, cardIds: [], createdAt: Date.now() };
            decksData.push(newDeck);

            const sheet = excelSheets[sheetName];
            if (!sheet || !sheet.data) return;

            const sheetData = sheet.data;
            const frontCol = sheetOptions[sheetName]?.frontColumn || 0;
            const backCol = sheetOptions[sheetName]?.backColumn || 1;

            for (let i = 1; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (!row || row.length === 0) continue;

                let frontText = '', frontImage = null, backText = '', backImage = null;

                const frontContentSource = row[frontCol];
                if(frontContentSource){
                    if (sheet.hasFormatting && typeof frontContentSource === 'object' && frontContentSource.delta) {
                        frontText = convertDeltaToHTML(frontContentSource.delta);
                    } else {
                        const processed = processImportedContent(String(frontContentSource));
                        frontText = processed.text ? processed.text.replace(/\n/g, '<br>') : '';
                        frontImage = processed.image;
                    }
                }

                if (stripHtml(frontText).trim() === '' && !frontImage) {
                    continue; // Skip if front is empty
                }

                const backContentSource = row[backCol];
                if(backContentSource){
                    if (sheet.hasFormatting && typeof backContentSource === 'object' && backContentSource.delta) {
                        backText = convertDeltaToHTML(backContentSource.delta);
                    } else {
                        const processed = processImportedContent(String(backContentSource));
                        backText = processed.text ? processed.text.replace(/\n/g, '<br>') : '';
                        backImage = processed.image;
                    }
                }

                const newCard = { id: Date.now() + Math.random(), frontText, frontImage, backText, backImage, nextReview: Date.now(), repetitions: 0, easeFactor: 2.0, interval: 1.0 };
                cardsData.push(newCard);
                newDeck.cardIds.push(newCard.id);
            }
        });
    }

    async function autoLoadDefaultGSheet() {
        const defaultUrl = localStorage.getItem('flashcard_defaultGSheetUrl');
        if (defaultUrl && GOOGLE_API_KEY) {
            console.log("偵測到預設 Google Sheet 連結，開始自動載入:", defaultUrl);
            const loadingToast = document.createElement('div');
            loadingToast.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center z-[100]';
            loadingToast.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>正在自動載入預設概念表...`;
            document.body.appendChild(loadingToast);
            try {
                const spreadsheetId = extractSpreadsheetId(defaultUrl);
                if (!spreadsheetId) throw new Error("無效的預設連結");
                await loadFormattedGSheetsData(spreadsheetId);
                processSheetsIntoCardsAndDecks();
                refreshAllViews();
                showNotification('預設概念表已成功載入！', 2500);
            } catch (error) {
                showNotification(`自動載入失敗: ${error.message}`, 4000);
            } finally {
                loadingToast.remove();
            }
        }
    }

    function initApiSettings() {
        const apiSettingsBtn = document.getElementById('apiSettingsBtn');
        const apiSettingsModal = document.getElementById('apiSettingsModal');
        const closeApiSettingsBtn = document.getElementById('closeApiSettingsBtn');
        const saveApiSettingsBtn = document.getElementById('saveApiSettingsBtn');
        const googleApiKeyInput = document.getElementById('googleApiKeyInput');
        const showApiKey = document.getElementById('showApiKey');

        apiSettingsBtn.addEventListener('click', () => {
            googleApiKeyInput.value = GOOGLE_API_KEY || '';
            apiSettingsModal.classList.remove('hidden');
        });

        closeApiSettingsBtn.addEventListener('click', () => apiSettingsModal.classList.add('hidden'));

        saveApiSettingsBtn.addEventListener('click', () => {
            const newApiKey = googleApiKeyInput.value.trim();
            GOOGLE_API_KEY = newApiKey;
            localStorage.setItem('google_api_key', newApiKey);
            updateApiKeyStatus();
            showNotification('API設置已保存');
            apiSettingsModal.classList.add('hidden');
        });

        showApiKey.addEventListener('change', () => {
            googleApiKeyInput.type = showApiKey.checked ? 'text' : 'password';
        });
    }

    // --- IMPORT/EXPORT (JSON) ---
    function openExportModal() {
        selectedExportDeckIds = [];
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
        document.getElementById('exportFilenameInput').value = `flashcards_backup_${dateStr}`;
        loadExportDecksList();
        document.getElementById('exportModal').classList.remove('hidden');
    }

    function loadExportDecksList() {
        const exportDecksList = document.getElementById('exportDecksList');
        exportDecksList.innerHTML = '';
        if (decksData.length === 0) {
            exportDecksList.innerHTML = '<div class="text-center py-4 text-gray-500 dark:text-gray-400">沒有可用的卡組。</div>';
            return;
        }
        const sortedDecks = [...decksData].sort((a, b) => a.name.localeCompare(b.name));
        selectedExportDeckIds = sortedDecks.map(deck => deck.id);
        sortedDecks.forEach(deck => {
            const deckItem = document.createElement('div');
            deckItem.className = 'flex items-center p-2 bg-gray-100 dark:bg-gray-700 rounded';
            deckItem.innerHTML = `<input type="checkbox" id="export-deck-${deck.id}" value="${deck.id}" class="mr-2" checked><label for="export-deck-${deck.id}" class="flex-1 flex justify-between items-center cursor-pointer"><span>${deck.name}</span><span class="text-xs text-gray-500 dark:text-gray-400">${deck.cardIds.length} 張字卡</span></label>`;
            exportDecksList.appendChild(deckItem);
            deckItem.querySelector('input').addEventListener('change', function() {
                const deckId = parseInt(this.value);
                if (this.checked) {
                    if (!selectedExportDeckIds.includes(deckId)) selectedExportDeckIds.push(deckId);
                } else {
                    selectedExportDeckIds = selectedExportDeckIds.filter(id => id !== deckId);
                }
            });
        });
    }

    function exportData() {
        if (selectedExportDeckIds.length === 0) {
            showNotification('請至少選擇一個卡組進行匯出');
            return;
        }
        const filename = document.getElementById('exportFilenameInput').value.trim() || 'flashcards_data';
        const selectedDecks = decksData.filter(deck => selectedExportDeckIds.includes(deck.id));
        const allCardIds = new Set(selectedDecks.flatMap(deck => deck.cardIds));
        const selectedCards = cardsData.filter(card => allCardIds.has(card.id));
        const exportObj = { version: "1.1", decksData: selectedDecks, cardsData: selectedCards, excelSheets: excelSheets };
        const jsonString = JSON.stringify(exportObj, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        document.getElementById('exportModal').classList.add('hidden');
        showNotification(`已匯出 ${selectedDecks.length} 個卡組`);
    }

    function handleImportFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                importDataCache = JSON.parse(event.target.result);
                if (!importDataCache.decksData || !importDataCache.cardsData) throw new Error("無效的備份檔案格式");
                openImportPreviewModal(importDataCache);
            } catch (error) {
                showNotification(`匯入失敗：${error.message}`);
            }
            e.target.value = '';
        };
        reader.readAsText(file);
    }

    function openImportPreviewModal(data) {
        selectedImportDeckIds = data.decksData.map(deck => String(deck.id));
        loadImportPreviewList(data);
        document.getElementById('importPreviewModal').classList.remove('hidden');
    }

    function loadImportPreviewList(data) {
        const importDecksList = document.getElementById('importDecksList');
        importDecksList.innerHTML = '';
        data.decksData.forEach(deck => {
            const conflict = decksData.some(d => d.name === deck.name);
            const deckItem = document.createElement('div');
            deckItem.className = `flex items-start p-2 bg-gray-100 dark:bg-gray-700 rounded ${conflict ? 'border-l-4 border-yellow-500' : ''}`;
            deckItem.innerHTML = `<input type="checkbox" id="import-deck-${deck.id}" value="${deck.id}" class="mr-2 mt-1" checked><div class="flex-1"><label for="import-deck-${deck.id}" class="flex justify-between items-center cursor-pointer"><span class="font-medium">${deck.name}</span><span class="text-xs text-gray-500 dark:text-gray-400">${deck.cardIds.length} 張字卡</span></label>${deck.description ? `<p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${deck.description}</p>` : ''}${conflict ? `<p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">注意：與現有卡組名稱衝突</p>` : ''}</div>`;
            importDecksList.appendChild(deckItem);
            deckItem.querySelector('input').addEventListener('change', function() {
                const deckId = this.value;
                if (this.checked) {
                    if (!selectedImportDeckIds.includes(deckId)) selectedImportDeckIds.push(deckId);
                } else {
                    selectedImportDeckIds = selectedImportDeckIds.filter(id => id !== deckId);
                }
            });
        });
    }

    function processImport() {
        if (!importDataCache || selectedImportDeckIds.length === 0) {
            document.getElementById('importPreviewModal').classList.add('hidden');
            return;
        }
        const conflictResolution = document.querySelector('input[name="conflictResolution"]:checked').value;
        const selectedDecksToImport = importDataCache.decksData.filter(deck => selectedImportDeckIds.includes(String(deck.id)));
        selectedDecksToImport.forEach(importDeck => {
            const conflictDeckIndex = decksData.findIndex(d => d.name === importDeck.name);
            if (conflictDeckIndex !== -1) {
                if (conflictResolution === 'skip') return;
                if (conflictResolution === 'overwrite') {
                    decksData.splice(conflictDeckIndex, 1);
                } else if (conflictResolution === 'rename') {
                    let counter = 1;
                    let newName = `${importDeck.name} (${counter})`;
                    while (decksData.some(d => d.name === newName)) {
                        counter++;
                        newName = `${importDeck.name} (${counter})`;
                    }
                    importDeck.name = newName;
                } else if (conflictResolution === 'merge') {
                    const existingDeck = decksData[conflictDeckIndex];
                    const newCardIds = importDeck.cardIds.filter(id => !existingDeck.cardIds.includes(id));
                    existingDeck.cardIds.push(...newCardIds);
                    const cardsToMerge = importDataCache.cardsData.filter(card => newCardIds.includes(card.id));
                    cardsData.push(...cardsToMerge);
                    return; // Skip adding deck again
                }
            }
            decksData.push(importDeck);
            const cardsToAdd = importDataCache.cardsData.filter(card => importDeck.cardIds.includes(card.id) && !cardsData.some(c => c.id === card.id));
            cardsData.push(...cardsToAdd);
        });

        // Import concept sheets if they exist in the backup
        if(importDataCache.excelSheets) {
            excelSheets = {...excelSheets, ...importDataCache.excelSheets};
        }

        document.getElementById('importPreviewModal').classList.add('hidden');
        refreshAllViews();
        saveDataToLocalStorage();
        importDataCache = null;
    }


    // --- IMPORT/EXPORT (EXCEL) ---

    function initExcelImport() {
        document.getElementById('importExcelBtn').addEventListener('click', openExcelImportModal);
        document.getElementById('closeImportExcelBtn').addEventListener('click', closeExcelImportModal);
        document.getElementById('excelFileInput').addEventListener('change', handleExcelFileSelect);
        document.getElementById('downloadExcelTemplateBtn').addEventListener('click', downloadExcelTemplate);
        document.getElementById('nextToPreviewBtn').addEventListener('click', () => { showExcelStep(2); preparePreviewData(); });
        document.getElementById('importNewFileBtn').addEventListener('click', () => { resetExcelImport(); showExcelStep(1); });
        document.getElementById('finishImportBtn').addEventListener('click', closeExcelImportModal);
        document.getElementById('backToFileBtn').addEventListener('click', () => showExcelStep(1));
        document.getElementById('importExcelDataBtn').addEventListener('click', importExcelDataFromModal);
    }

    function openExcelImportModal() {
        resetExcelImport();
        document.getElementById('importExcelModal').classList.remove('hidden');
    }

    function closeExcelImportModal() {
        document.getElementById('importExcelModal').classList.add('hidden');
    }

    function resetExcelImport() {
        excelSheets = {};
        activeSheetName = '';
        sheetMappings = {};
        sheetOptions = {};
        document.getElementById('excelFileInput').value = '';
        document.getElementById('excelFileName').classList.add('hidden');
        document.getElementById('nextToPreviewBtn').disabled = true;
        showExcelStep(1);
    }

    function showExcelStep(step) {
        document.getElementById('excelStep1').classList.toggle('hidden', step !== 1);
        document.getElementById('excelStep2').classList.toggle('hidden', step !== 2);
        document.getElementById('excelStep3').classList.toggle('hidden', step !== 3);
    }

    function handleExcelFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('excelFileName').textContent = `選擇的檔案: ${file.name}`;
        document.getElementById('excelFileName').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                if (workbook.SheetNames.length === 0) throw new Error('Excel文件必須至少包含一個工作表');

                excelSheets = {}; // Reset for new file
                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (sheetData.length < 2) return;
                    excelSheets[sheetName] = { data: sheetData, columns: sheetData[0], hasFormatting: false };
                    sheetMappings[sheetName] = { deckOption: 'new', deckId: '', newDeckName: sheetName, newDeckDescription: '' };
                    sheetOptions[sheetName] = { frontColumn: 0, backColumn: 1 };
                });
                activeSheetName = workbook.SheetNames[0];
                document.getElementById('nextToPreviewBtn').disabled = false;
            } catch (error) {
                showNotification(`解析Excel文件時出錯: ${error.message}`);
                resetExcelImport();
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function preparePreviewData() {
        if (Object.keys(excelSheets).length === 0) return;
        updateSheetTabs();
        showSheetPreview(activeSheetName);
        updateSheetMappingOptions();
    }

    function updateSheetTabs() {
        const container = document.getElementById('sheetTabsContainer');
        container.innerHTML = '';
        Object.keys(excelSheets).forEach(sheetName => {
            const tab = document.createElement('div');
            tab.className = `sheet-tab ${sheetName === activeSheetName ? 'active' : ''}`;
            tab.textContent = sheetName;
            tab.dataset.sheet = sheetName;
            tab.addEventListener('click', () => {
                document.querySelectorAll('.sheet-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeSheetName = sheetName;
                showSheetPreview(sheetName);
                updateColumnSelectors(sheetName);
            });
            container.appendChild(tab);
        });
    }

    function showSheetPreview(sheetName) {
        if (!excelSheets[sheetName]) return;
        const { data, columns } = excelSheets[sheetName];
        const head = document.getElementById('excelPreviewHead');
        const body = document.getElementById('excelPreviewBody');
        head.innerHTML = '';
        body.innerHTML = '';
        const headerRow = head.insertRow();
        columns.forEach(col => headerRow.insertCell().textContent = col);
        const previewRows = Math.min(data.length - 1, 5);
        for (let i = 1; i <= previewRows; i++) {
            const tr = body.insertRow();
            data[i].forEach(cell => tr.insertCell().textContent = String(cell || '').substring(0, 50));
        }
        document.getElementById('excelRowCount').textContent = `共 ${data.length - 1} 行數據`;
        updateColumnSelectors(sheetName);
    }

    function updateColumnSelectors(sheetName) {
        const frontSelect = document.getElementById('frontColumnSelect');
        const backSelect = document.getElementById('backColumnSelect');
        frontSelect.innerHTML = '';
        backSelect.innerHTML = '';
        const columns = excelSheets[sheetName].columns;
        columns.forEach((col, index) => {
            frontSelect.add(new Option(col, index));
            backSelect.add(new Option(col, index));
        });
        const options = sheetOptions[sheetName];
        if (options) {
            frontSelect.value = options.frontColumn;
            backSelect.value = options.backColumn;
        }
        frontSelect.onchange = () => sheetOptions[sheetName].frontColumn = parseInt(frontSelect.value);
        backSelect.onchange = () => sheetOptions[sheetName].backColumn = parseInt(backSelect.value);
    }

    function updateSheetMappingOptions() {
        const container = document.getElementById('sheetMappingContainer');
        container.innerHTML = '';
        Object.keys(excelSheets).forEach(sheetName => {
            const mapping = sheetMappings[sheetName];
            const mappingElement = document.createElement('div');
            mappingElement.className = 'border border-gray-300 dark:border-gray-700 rounded-lg p-3 mb-2';
            mappingElement.innerHTML = `<h4 class="font-medium mb-2">工作表「${sheetName}」</h4><div class="space-y-2"><div><label class="flex items-center"><input type="radio" name="deckOption-${sheetName}" value="existing" ${mapping.deckOption === 'existing' ? 'checked' : ''} class="mr-2"><span>添加到現有卡組</span></label><div class="existing-deck-selector ml-6 mt-1 ${mapping.deckOption === 'existing' ? '' : 'hidden'}"><select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800">${decksData.map(deck => `<option value="${deck.id}" ${mapping.deckId == deck.id ? 'selected' : ''}>${deck.name}</option>`).join('')}</select></div></div><div><label class="flex items-center"><input type="radio" name="deckOption-${sheetName}" value="new" ${mapping.deckOption === 'new' ? 'checked' : ''} class="mr-2"><span>創建新卡組</span></label><div class="new-deck-inputs ml-6 mt-1 ${mapping.deckOption === 'new' ? '' : 'hidden'}"><input type="text" placeholder="卡組名稱" value="${mapping.newDeckName}" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 mb-2"><textarea placeholder="卡組描述（選填）" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800" rows="2">${mapping.newDeckDescription}</textarea></div></div></div>`;
            container.appendChild(mappingElement);

            const existingRadio = mappingElement.querySelector(`input[value="existing"]`);
            const newRadio = mappingElement.querySelector(`input[value="new"]`);
            const existingSelector = mappingElement.querySelector('.existing-deck-selector');
            const newInputs = mappingElement.querySelector('.new-deck-inputs');

            existingRadio.onchange = () => { existingSelector.classList.remove('hidden'); newInputs.classList.add('hidden'); mapping.deckOption = 'existing'; mapping.deckId = existingSelector.querySelector('select').value; };
            newRadio.onchange = () => { existingSelector.classList.add('hidden'); newInputs.classList.remove('hidden'); mapping.deckOption = 'new'; };
            existingSelector.querySelector('select').onchange = (e) => mapping.deckId = e.target.value;
            newInputs.querySelector('input').oninput = (e) => mapping.newDeckName = e.target.value;
            newInputs.querySelector('textarea').oninput = (e) => mapping.newDeckDescription = e.target.value;
        });
    }

    function downloadExcelTemplate() {
        const wb = XLSX.utils.book_new();
        const data = [['正面內容', '背面內容', '備註(選填)'], ['Apple', '蘋果', '水果']];
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, '範例');
        XLSX.writeFile(wb, '概念表模板.xlsx');
    }

    function importExcelDataFromModal() {
        if (Object.keys(excelSheets).length === 0) return;
        const results = [];
        for (const sheetName in excelSheets) {
            const { data } = excelSheets[sheetName];
            const { deckOption, deckId, newDeckName, newDeckDescription } = sheetMappings[sheetName];
            const { frontColumn, backColumn } = sheetOptions[sheetName];
            if (frontColumn === backColumn) {
                results.push({ sheetName, success: false, message: '正面和背面不能選擇相同的欄位' });
                continue;
            }
            try {
                let targetDeckId, targetDeckName, newDeckCreated = false;
                if (deckOption === 'existing') {
                    targetDeckId = parseInt(deckId);
                    targetDeckName = decksData.find(d => d.id === targetDeckId)?.name;
                    if (!targetDeckName) throw new Error("找不到目標卡組");
                } else {
                    if (!newDeckName.trim()) throw new Error("新卡組名稱不能為空");
                    const newDeck = { id: Date.now() + Math.random(), name: newDeckName.trim(), description: newDeckDescription.trim(), cardIds: [], createdAt: Date.now() };
                    decksData.push(newDeck);
                    targetDeckId = newDeck.id;
                    targetDeckName = newDeck.name;
                    newDeckCreated = true;
                }
                const targetDeck = decksData.find(d => d.id === targetDeckId);
                let importedCount = 0;
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (!row || (!row[frontColumn] && !row[backColumn])) continue;
                    const processedFront = processImportedContent(row[frontColumn]);
                    const processedBack = processImportedContent(row[backColumn]);
                    if (!processedFront.text && !processedFront.image) continue;
                    const newCard = { id: Date.now() + Math.random(), frontText: processedFront.text.replace(/\n/g, '<br>'), frontImage: processedFront.image, backText: processedBack.text.replace(/\n/g, '<br>'), backImage: processedBack.image, nextReview: Date.now(), repetitions: 0, easeFactor: 2.0, interval: 1.0 };
                    cardsData.push(newCard);
                    targetDeck.cardIds.push(newCard.id);
                    importedCount++;
                }
                results.push({ sheetName, success: true, targetDeckName, importedCount, newDeckCreated });
            } catch (error) {
                results.push({ sheetName, success: false, message: error.message });
            }
        }
        refreshAllViews();
        saveDataToLocalStorage();
        showExcelStep(3);
        displayMultiSheetImportResults(results);
    }

    function displayMultiSheetImportResults(results) {
        const container = document.getElementById('importResults');
        let totalSuccess = results.filter(r => r.success).length;
        let totalFailed = results.length - totalSuccess;
        let totalCards = results.filter(r => r.success).reduce((sum, r) => sum + r.importedCount, 0);
        container.innerHTML = `<div class="mb-4 border-b pb-3 border-gray-300 dark:border-gray-700"><h3 class="font-medium mb-2 ${totalFailed > 0 ? 'text-yellow-600' : 'text-green-600'}">導入完成</h3><p>成功處理 ${totalSuccess} 個工作表，失敗 ${totalFailed} 個，共導入 ${totalCards} 張字卡</p></div>`;
        const detailsContainer = document.createElement('div');
        detailsContainer.className = "space-y-3";
        results.forEach(result => {
            const resultElement = document.createElement('div');
            resultElement.className = `p-3 rounded ${result.success ? 'bg-green-50 dark:bg-green-900/30' : 'bg-red-50 dark:bg-red-900/30'}`;
            resultElement.innerHTML = result.success ? `<h4 class="font-medium">工作表「${result.sheetName}」- 成功</h4><p>導入 ${result.importedCount} 張字卡</p><p>卡組: ${result.targetDeckName} ${result.newDeckCreated ? '(新建)' : '(現有)'}</p>` : `<h4 class="font-medium text-red-600 dark:text-red-400">工作表「${result.sheetName}」- 失敗</h4><p>${result.message}</p>`;
            detailsContainer.appendChild(resultElement);
        });
        container.appendChild(detailsContainer);
    }

    function openExportExcelModal() {
        selectedExportExcelDeckIds = [];
        const now = new Date();
        const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
        document.getElementById('exportExcelFilenameInput').value = `concepts_${dateStr}`;
        loadExportExcelDecksList();
        document.getElementById('exportExcelModal').classList.remove('hidden');
    }

    function loadExportExcelDecksList() {
        const container = document.getElementById('exportExcelDecksList');
        container.innerHTML = '';
        if(decksData.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-gray-500">沒有可用的卡組。</div>';
            return;
        }
        const sortedDecks = [...decksData].sort((a,b) => a.name.localeCompare(b.name));
        selectedExportExcelDeckIds = sortedDecks.map(d => d.id);
        sortedDecks.forEach(deck => {
            const item = document.createElement('div');
            item.className = 'flex items-center p-2 bg-gray-100 dark:bg-gray-700 rounded';
            item.innerHTML = `<input type="checkbox" id="export-excel-deck-${deck.id}" value="${deck.id}" class="mr-2" checked><label for="export-excel-deck-${deck.id}" class="flex-1 cursor-pointer">${deck.name}</label>`;
            container.appendChild(item);
            item.querySelector('input').addEventListener('change', function(){
                const deckId = parseInt(this.value);
                if(this.checked) selectedExportExcelDeckIds.push(deckId);
                else selectedExportExcelDeckIds = selectedExportExcelDeckIds.filter(id => id !== deckId);
            });
        });
    }

    function exportExcelData() {
        if (selectedExportExcelDeckIds.length === 0) {
            showNotification('請至少選擇一個卡組導出');
            return;
        }
        const filename = document.getElementById('exportExcelFilenameInput').value.trim() || 'concepts';
        const wb = XLSX.utils.book_new();
        decksData.filter(d => selectedExportExcelDeckIds.includes(d.id)).forEach(deck => {
            const sheetData = [['正面內容', '背面內容']];
            cardsData.filter(c => deck.cardIds.includes(c.id)).forEach(card => {
                sheetData.push([stripHtml(card.frontText), stripHtml(card.backText)]);
            });
            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            let sheetName = deck.name.replace(/[\[\]\*\/\\\?:]/g, '_').substring(0, 31);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });
        XLSX.writeFile(wb, `${filename}.xlsx`);
        document.getElementById('exportExcelModal').classList.add('hidden');
        showNotification('成功導出至Excel');
    }

    // --- INITIALIZATION ---
    function initApp() {
        loadDataFromLocalStorage();
        autoLoadDefaultGSheet();

        setupSidebarAndNavigation();
        initGSheetsImport();
        initApiSettings();
        initExcelImport();

        // Setup Export Buttons
        document.getElementById('exportDataBtn').addEventListener('click', openExportModal);
        document.getElementById('confirmExportBtn').addEventListener('click', exportData);
        document.getElementById('cancelExportBtn').addEventListener('click', () => document.getElementById('exportModal').classList.add('hidden'));
        document.getElementById('selectAllExportDecksBtn').addEventListener('click', () => document.querySelectorAll('#exportDecksList input').forEach(c => c.checked=true) || (selectedExportDeckIds = decksData.map(d => d.id)));
        document.getElementById('deselectAllExportDecksBtn').addEventListener('click', () => document.querySelectorAll('#exportDecksList input').forEach(c => c.checked=false) || (selectedExportDeckIds = []));

        document.getElementById('exportExcelBtn').addEventListener('click', openExportExcelModal);
        document.getElementById('confirmExportExcelBtn').addEventListener('click', exportExcelData);
        document.getElementById('cancelExportExcelBtn').addEventListener('click', () => document.getElementById('exportExcelModal').classList.add('hidden'));
        document.getElementById('selectAllExportExcelDecksBtn').addEventListener('click', () => document.querySelectorAll('#exportExcelDecksList input').forEach(c => c.checked=true) || (selectedExportExcelDeckIds = decksData.map(d => d.id)));
        document.getElementById('deselectAllExportExcelDecksBtn').addEventListener('click', () => document.querySelectorAll('#exportExcelDecksList input').forEach(c => c.checked=false) || (selectedExportExcelDeckIds = []));

        // Setup Import Buttons
        document.getElementById('importDataInput').addEventListener('change', handleImportFile);
        document.getElementById('confirmImportBtn').addEventListener('click', processImport);
        document.getElementById('cancelImportBtn').addEventListener('click', () => document.getElementById('importPreviewModal').classList.add('hidden'));
        document.getElementById('selectAllImportDecksBtn').addEventListener('click', () => document.querySelectorAll('#importDecksList input').forEach(c => c.checked=true) || (selectedImportDeckIds = importDataCache.decksData.map(d => String(d.id))));
        document.getElementById('deselectAllImportDecksBtn').addEventListener('click', () => document.querySelectorAll('#importDecksList input').forEach(c => c.checked=false) || (selectedImportDeckIds = []));

        // Setup Local Storage Buttons
        document.getElementById('forceSaveBtn').addEventListener('click', () => {
            saveDataToLocalStorage();
            showNotification('已手動儲存所有資料！');
        });
        document.getElementById('clearLocalStorageBtn').addEventListener('click', clearLocalStorageData);

        // Set default view
        window.showSection('keyConcepts');
    }

    document.addEventListener('DOMContentLoaded', initApp);

</script>
</html>
